<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arƒ±za GIS & Fider K√ºt√ºphanesi</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.js"></script>

    <style>
        :root { --primary: #1a73e8; --secondary: #34495e; --bg: #f0f2f5; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 600px; width: 100%; margin-bottom: 15px; box-sizing: border-box; }
        h2, h3 { margin-top: 0; color: var(--primary); text-align: center; font-size: 18px; }
        
        .lib-section { border: 2px dashed #ccc; padding: 10px; border-radius: 8px; background: #fafafa; }
        select, input, button { width: 100%; padding: 12px; margin-top: 8px; border-radius: 8px; border: 1px solid #ddd; font-size: 14px; box-sizing: border-box; }
        
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
        .btn-add { background: #34a853; margin-top: 5px; }
        .btn-delete { background: #ea4335; font-size: 11px; padding: 5px; width: auto; margin-top: 5px; }
        
        #map { height: 350px; width: 100%; border-radius: 12px; margin-top: 10px; z-index: 1; }
        .result-panel { background: #e7f3ff; padding: 15px; border-radius: 8px; border-left: 5px solid var(--primary); display: none; margin-top: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h2>üìÅ Fider K√ºt√ºphanesi</h2>
    <div class="lib-section">
        <label style="font-size: 12px; font-weight: bold;">Yeni KML Ekle:</label>
        <input type="text" id="fiderName" placeholder="Fider ƒ∞smi (√ñrn: Organize-1)">
        <input type="file" id="kmlInput" accept=".kml">
        <button class="btn-add" onclick="saveToLibrary()">K√úT√úPHANEYE KAYDET</button>
    </div>

    <div style="margin-top: 15px;">
        <label style="font-size: 12px; font-weight: bold;">Kayƒ±tlƒ± Fider Se√ß:</label>
        <select id="fiderSelect" onchange="loadFiderFromLibrary()">
            <option value="">-- Fider Se√ßiniz --</option>
        </select>
        <div id="deleteZone"></div>
    </div>
</div>

<div class="card">
    <h3>‚ö° Arƒ±za Analizi</h3>
    <div style="display: flex; gap: 8px;">
        <div style="flex:1"><label style="font-size:11px;">Akƒ±m (A)</label><input type="number" id="ampInput" placeholder="Amper"></div>
        <div style="flex:1"><label style="font-size:11px;">ƒ∞letken Œ©/km</label>
            <select id="zInput">
                <option value="0.355">Hawk (0.355)</option>
                <option value="0.496">Pigeon (0.496)</option>
                <option value="1.433">Swallow (1.433)</option>
            </select>
        </div>
    </div>
    <button onclick="calculateFaultLocation()">HARƒ∞TADA NOKTAYI BUL</button>

    <div id="map"></div>

    <div id="resultPanel" class="result-panel">
        <strong>Mesafe: <span id="distRes"></span> km</strong><br>
        <span id="coordRes" style="font-size: 12px; color: #555;"></span>
        <button onclick="goNav()" style="background:#4285F4; margin-top:10px;">Navigasyonu Ba≈ülat</button>
    </div>
</div>

<script>
    let map = L.map('map').setView([39.0, 35.0], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let currentRouteCoords = [];
    let routeLayer = null;
    let markerLayer = null;
    let library = JSON.parse(localStorage.getItem('fiderLibrary')) || {};

    // K√ºt√ºphaneyi Ba≈ülat
    updateFiderList();

    function saveToLibrary() {
        const name = document.getElementById('fiderName').value;
        const file = document.getElementById('kmlInput').files[0];

        if (!name || !file) return alert("ƒ∞sim girin ve dosya se√ßin!");

        const reader = new FileReader();
        reader.onload = function(e) {
            const parser = new DOMParser();
            const kml = parser.parseFromString(e.target.result, "text/xml");
            const converted = toGeoJSON.kml(kml);
            const coords = converted.features[0].geometry.coordinates.map(c => [c[1], c[0]]);

            library[name] = coords;
            localStorage.setItem('fiderLibrary', JSON.stringify(library));
            updateFiderList();
            alert(name + " k√ºt√ºphaneye eklendi.");
        };
        reader.readAsText(file);
    }

    function updateFiderList() {
        const select = document.getElementById('fiderSelect');
        select.innerHTML = '<option value="">-- Fider Se√ßiniz --</option>';
        for (let name in library) {
            let opt = document.createElement('option');
            opt.value = name;
            opt.innerText = name;
            select.appendChild(opt);
        }
    }

    function loadFiderFromLibrary() {
        const name = document.getElementById('fiderSelect').value;
        if (!name) return;

        currentRouteCoords = library[name];
        if (routeLayer) map.removeLayer(routeLayer);
        
        routeLayer = L.polyline(currentRouteCoords, {color: 'blue', weight: 4}).addTo(map);
        map.fitBounds(routeLayer.getBounds());
        
        document.getElementById('deleteZone').innerHTML = `<button class="btn-delete" onclick="deleteFider('${name}')">Bu Fideri Sil</button>`;
    }

    function deleteFider(name) {
        if(confirm(name + " silinsin mi?")) {
            delete library[name];
            localStorage.setItem('fiderLibrary', JSON.stringify(library));
            updateFiderList();
            if (routeLayer) map.removeLayer(routeLayer);
            document.getElementById('deleteZone').innerHTML = '';
        }
    }

    function calculateFaultLocation() {
        const amp = parseFloat(document.getElementById('ampInput').value);
        const zUnit = parseFloat(document.getElementById('zInput').value);
        
        if (!amp || currentRouteCoords.length === 0) return alert("Hata: Verileri kontrol edin!");

        const targetDistKm = (31500 / 1.732 / amp) / zUnit;
        const targetMeters = targetDistKm * 1000;

        let travelled = 0;
        let foundCoord = null;

        for (let i = 0; i < currentRouteCoords.length - 1; i++) {
            let p1 = L.latLng(currentRouteCoords[i]);
            let p2 = L.latLng(currentRouteCoords[i+1]);
            let segmentDist = p1.distanceTo(p2);

            if (travelled + segmentDist >= targetMeters) {
                let ratio = (targetMeters - travelled) / segmentDist;
                foundCoord = [
                    p1.lat + (p2.lat - p1.lat) * ratio,
                    p1.lng + (p2.lng - p1.lng) * ratio
                ];
                break;
            }
            travelled += segmentDist;
        }

        if (!foundCoord) foundCoord = currentRouteCoords[currentRouteCoords.length - 1];

        if (markerLayer) map.removeLayer(markerLayer);
        markerLayer = L.marker(foundCoord).addTo(map).bindPopup("Arƒ±za Noktasƒ±").openPopup();
        map.setView(foundCoord, 15);

        document.getElementById('resultPanel').style.display = "block";
        document.getElementById('distRes').innerText = targetDistKm.toFixed(2);
        document.getElementById('coordRes').innerText = `Konum: ${foundCoord[0].toFixed(6)}, ${foundCoord[1].toFixed(6)}`;
        window.targetPoint = foundCoord;
    }

    function goNav() {
        if(window.targetPoint) {
            window.open(`https://www.google.com/maps?q=${window.targetPoint[0]},${window.targetPoint[1]}`);
        }
    }
</script>
</body>
</html>